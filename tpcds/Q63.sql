
SELECT  s_store_name
      ,SUM(ss_net_profit)
 FROM store_sales
     ,date_dim
     ,store,
     (SELECT ca_zip
     FROM (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '26235','81852','16733','50732','97121','55976',
                          '85109','14035','63108','80507','81398',
                          '51092','45114','71658','32648','90182',
                          '12417','17197','37146','44134','84061',
                          '55117','84541','82050','85191','59154',
                          '34150','46390','77220','39981','43662',
                          '36511','14147','13007','27926','31632',
                          '53658','42493','12967','31333','39214',
                          '74260','27293','41852','72881','46068',
                          '48245','21669','33679','67181','14683',
                          '65389','10425','48563','22352','20220',
                          '66026','66417','54082','41226','87459',
                          '32196','15368','40869','40726','58206',
                          '18351','77128','30017','79047','51764',
                          '62823','59695','46288','61755','67203',
                          '41395','17014','56105','14537','55240',
                          '81573','85659','39674','37198','33500',
                          '69676','92168','69453','47631','57862',
                          '98827','86404','81237','14396','87662',
                          '48501','34487','63041','47318','89776',
                          '77728','23239','70139','37514','88136',
                          '62073','71211','46364','30907','33585',
                          '10013','42800','62657','74724','40363',
                          '64696','82518','32982','14233','56444',
                          '37397','88132','61728','21558','83267',
                          '13597','86177','98043','21660','67204',
                          '93615','21735','23904','35189','77744',
                          '43713','68025','22044','90382','13872',
                          '47074','17849','32175','86100','20223',
                          '11259','74990','32961','30458','32028',
                          '52544','35763','43430','39550','48781',
                          '22936','30495','15955','22830','65864',
                          '28207','93798','61460','12792','54423',
                          '56809','49681','47268','76949','86846',
                          '74968','25254','45643','73180','68046',
                          '98928','25926','22723','54789','25334',
                          '51527','27665','11431','34682','85833',
                          '83653','86666','35675','19725','26756',
                          '28331','24024','39120','16791','92907',
                          '24514','20587','53506','30918','37159',
                          '88893','76458','20229','60164','45868',
                          '12910','72855','80242','42185','13263',
                          '29524','25827','39392','23685','30639',
                          '35655','43226','15693','97147','30721',
                          '15737','11234','33929','96247','19579',
                          '20752','26919','92729','58191','18833',
                          '12267','95983','17256','16464','33362',
                          '76581','29825','52079','58442','82424',
                          '37873','66895','69518','84488','10768',
                          '51415','54677','35086','80541','87434',
                          '38960','19716','54282','51339','50690',
                          '46169','88040','34558','75108','83949',
                          '66718','71799','90538','57250','70347',
                          '69046','60462','38179','31317','38829',
                          '33264','20852','22482','21901','79808',
                          '95072','41765','57721','50634','17161',
                          '70721','42891','74763','50122','77535',
                          '28839','53349','15962','77074','69380',
                          '34859','43172','65875','21348','65038',
                          '96226','75349','40977','31644','73652',
                          '92299','16670','43201','89607','21436',
                          '67082','77005','72413','95369','86140',
                          '12146','36435','44127','46423','39717',
                          '33224','89184','23999','17813','57162',
                          '77144','34076','21145','40250','38607',
                          '25574','24662','77489','46110','37893',
                          '15557','80931','30790','81118','27543',
                          '13353','23519','10982','22108','18848',
                          '33365','97204','43261','64064','49317',
                          '11779','48466','41299','45001','47515',
                          '39479','79394','16561','34450','81050',
                          '66364','30658','14920','57886','95738',
                          '60005','47953','50835','14682','66557',
                          '13769','39858','59269','92971','99503',
                          '20681','10543','10696','74645','29720',
                          '18458','35644','52674','29018','40062',
                          '22573','10315','82489','81755','26538',
                          '53396','80162','41142','60436','31319',
                          '43969','64834','19978','70283','78500',
                          '30684','87304','84584','37619')
     intersect
      SELECT ca_zip
      FROM (SELECT substr(ca_zip,1,5) ca_zip,COUNT(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk AND
                  c_preferred_cust_flag='Y'
            GROUP BY ca_zip
            having COUNT(*) > 10)A1)A2) V1
 WHERE ss_store_sk = s_store_sk
  AND ss_sold_date_sk = d_date_sk
  AND d_qoy = 1 AND d_year = 1998
  AND (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 GROUP BY s_store_name
 ORDER BY s_store_name
 LIMIT 100;
